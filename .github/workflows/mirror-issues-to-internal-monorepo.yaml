name: Mirror issues to internal

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: read

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Prepare data
        id: prep
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          SRC_REPO: ${{ github.repository }}
          SRC_NUM: ${{ github.event.issue.number }}
        run: |
          echo "title=External[FastSlide]: ${ISSUE_TITLE}" >> "$GITHUB_OUTPUT"
          cat > body.txt <<EOF
ðŸ”— **Source:** https://github.com/${SRC_REPO}/issues/${SRC_NUM}

---
${ISSUE_BODY}

---
External-Source: ${SRC_REPO}#${SRC_NUM}
EOF
          {
            echo "body<<BODY"
            cat body.txt
            echo "BODY"
          } >> "$GITHUB_OUTPUT"

      - name: Avoid duplicates (if manually re-run)
        id: dedupe
        env:
          GH_TOKEN: ${{ secrets.INTERNAL_REPO_PAT }}
          REPO: NKI-AI/aiforoncology-internal
          SRC_REPO: ${{ github.repository }}
          SRC_NUM: ${{ github.event.issue.number }}
        run: |
          Q="repo:${REPO} is:issue in:body \"External-Source: ${SRC_REPO}#${SRC_NUM}\""
          COUNT=$(gh api -X GET search/issues -f q="$Q" --jq '.total_count')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Create mirrored issue in internal repo
        if: steps.dedupe.outputs.count == '0'
        env:
          GH_TOKEN: ${{ secrets.INTERNAL_REPO_PAT }}
          TITLE: ${{ steps.prep.outputs.title }}
          BODY: ${{ steps.prep.outputs.body }}
        run: |
          gh api repos/NKI-AI/aiforoncology-internal/issues \
            -f title="$TITLE" \
            -f body="$BODY" \
            -f labels="external-fastslide" \
            --jq '.number' | xargs -I {} echo "Mirrored as internal issue #{}"
