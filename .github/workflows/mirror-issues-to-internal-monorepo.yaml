name: Mirror issues to internal

on:
  issues:
    types: [opened]

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Mirror to aiforoncology-internal
        env:
          GH_TOKEN: ${{ secrets.INTERNAL_REPO_PAT }}
          REPO_INTERNAL: NKI-AI/aiforoncology-internal
          SRC_REPO: ${{ github.repository }}
          SRC_NUM: ${{ github.event.issue.number }}
          SRC_TITLE: ${{ github.event.issue.title }}
          SRC_BODY: ${{ github.event.issue.body }}
        shell: bash
        run: |
          # Ensure gh exists (ubuntu-latest usually has it)
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y gh
          fi

          TITLE="External[FastSlide]: ${SRC_TITLE}"

          # De-dupe: look for our unique marker in internal repo
          Q="repo:${REPO_INTERNAL} is:issue in:body \"External-Source: ${SRC_REPO}#${SRC_NUM}\""
          COUNT=$(gh api -X GET search/issues -f q="$Q" --jq '.total_count')
          if [ "$COUNT" -gt 0 ]; then
            echo "Already mirrored. Skipping."
            exit 0
          fi

          # Compose body
          {
            echo "ðŸ”— **Source:** https://github.com/${SRC_REPO}/issues/${SRC_NUM}"
            echo
            echo '---'
            [ -n "${SRC_BODY}" ] && echo "${SRC_BODY}"
            echo
            echo '---'
            echo "External-Source: ${SRC_REPO}#${SRC_NUM}"
          } > /tmp/body.md

          # Create internal issue
          gh api "repos/${REPO_INTERNAL}/issues" \
            -f title="$TITLE" \
            -f body="$(cat /tmp/body.md)" \
            -f labels="external-fastslide"
