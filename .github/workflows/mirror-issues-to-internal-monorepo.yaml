name: Mirror issues to internal

on:
  issues:
    types: [opened]

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Mirror to aiforoncology-internal using gh
        env:
          # PAT with Issues: Read/Write on NKI-AI/aiforoncology-internal
          GH_TOKEN: ${{ secrets.INTERNAL_REPO_PAT }}
          REPO_INTERNAL: NKI-AI/aiforoncology-internal

          SRC_REPO: ${{ github.repository }}
          SRC_NUM: ${{ github.event.issue.number }}
          SRC_TITLE: ${{ github.event.issue.title }}
          SRC_BODY: ${{ github.event.issue.body }}
        shell: bash
        run: |
          # Ensure gh is available
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y gh
          fi

          TITLE="External[FastSlide]: ${SRC_TITLE}"

          # Compose body with backlink + unique marker
          cat > /tmp/body.md <<EOF
ðŸ”— **Source:** https://github.com/${SRC_REPO}/issues/${SRC_NUM}

---
${SRC_BODY:-_No description provided._}

---
External-Source: ${SRC_REPO}#${SRC_NUM}
EOF

          # De-dupe: search for the unique marker in the internal repo
          COUNT=$(gh search issues \
            --repo "$REPO_INTERNAL" \
            --match body \
            --include-prs=false \
            "External-Source: ${SRC_REPO}#${SRC_NUM}" \
            --json totalCount --jq '.totalCount')

          if [ "$COUNT" -gt 0 ]; then
            echo "Already mirrored. Skipping."
            exit 0
          fi

          # Create the mirrored issue with label
          gh issue create \
            --repo "$REPO_INTERNAL" \
            --title "$TITLE" \
            --body-file /tmp/body.md \
            --label "external-fastslide"

          echo "Mirrored successfully."
