# copy.bara.sky

# This configuration file sets up a Copybara workflow to sync a specific part of NKI-AI/aiforoncology-internal
# to the NKI-AI/aiforoncology repository.

# Update the following fields according to your needs:
#   - In 'origin', change the URL and ref to match your source repository and branch.
#   - In 'destination', ensure the URL and push branch point to the target repository.
#   - The 'origin_files' glob restricts the sync to the specific part of the project you want to mirror. Adjust it 
#   (e.g., "sync_folder/**") as necessary.

REFERENCE_REPO_URL = "git@github.com:NKI-AI/aiforoncology-internal.git" # The source repository URL to sync from.
REFERENCE_BRANCH = "feature/slideinsight-api"  # The branch in the source repository to sync from.

TARGET_REPO_URL = "git@github.com:NKI-AI/fastslide.git" # The destination repository URL to sync to.
TARGET_BRANCH = "sync/internal"  # The branch in the destination repository to sync to.

# Configurable list of files (e.g. README.md)
GENERAL_FILES = [
    "aifo/fastslide/README_PUBLIC.md",
    "aifo/fastslide/meson.build",
    "aifo/fastslide/LICENSE",
    "aifo/fastslide/meson_options.txt",
    "aifo/fastslide/MANIFEST.in",
    "aifo/fastslide/pyproject.toml",
    "aifo/fastslide/requirements_linux.txt",
    "aifo/fastslide/requirements_darwin.txt",
]

# Configurable list of source globs (e.g. src/python)
SRC_GLOBS = [
    "aifo/fastslide/src/**",
    "aifo/fastslide/include/**",
    "aifo/fastslide/python/**",
    "aifo/aifocore/src/**",
    "aifo/aifocore/include/**",
    "third_party/lodepng/**",
]

# Configurable list of other globs for projects to copy over.
OTHER_GLOBS = [
    "aifo/fastslide/benchmarks/**",
    "aifo/fastslide/docs/**",
    "aifo/fastslide/examples/**",
    "aifo/fastslide/tests/**",
    "aifo/fastslide/tools/**",
    "aifo/fastslide/subprojects/**",
]

EXCLUDED_FILES = [
    "**/*.bazel",
    "**/*.BUILD",
]

core.workflow(
    name = "default",
    origin = git.origin(
        url = REFERENCE_REPO_URL,
        ref = REFERENCE_BRANCH,
        partial_fetch = True,  # Use partial clone to avoid downloading all LFS files
    ),
    destination = git.destination(
        url = TARGET_REPO_URL,
        fetch = TARGET_BRANCH,
        push = TARGET_BRANCH,
    ),

    origin_files = GENERAL_FILES + glob(SRC_GLOBS + OTHER_GLOBS, exclude = EXCLUDED_FILES),
    destination_files = glob(["**"]),
    transformations = [
        core.move(
            before = "aifo/fastslide/src/",
            after = "src/fastslide/"
        ),
        core.move(
            before = "aifo/aifocore/src/",
            after = "src/aifocore/"
        ),
        core.move(
            before = "aifo/fastslide/",
            after = ""
        ),
        core.move(
            before = "aifo/aifocore/",
            after = ""
        ),
        core.replace(
            before = "\"aifo/fastslide/src/",
            after = "\"src/fastslide/",
            regex_groups = {},
            paths = glob(["**/*.cpp", "**/*.h"])
        ),
        core.move(
            before = "README_PUBLIC.md",
            after = "README.md"
        )
    ],
    authoring = authoring.pass_thru("Jonas Teuwen <j.teuwen@nki.nl>")
)

# To execute the workflow, run:
#   bazel run //tools:copybara -- migrate <absolute_path_to_copy.bara.sky>
# If it's your first time running Copybara in specific target, you may need to initialize it first:
#   bazel run //tools:copybara -- migrate <absolute_path_to_copy.bara.sky> --init-history
# You can also use the `--force` flag to overwrite existing files in the destination repository.

# Ensure you have the necessary permissions and that the branches exist in both repositories.
